---
title: "TRABAJO FINAL- Estadística Computacional (SP-1669)"
author: "Javier Padilla H. - David Pérez C. - Natalie Mora - Luis Jesús Molina"
output: 
  html_document:
    theme: flatly
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  fig.align = 'center',
  fig.retina = 2,
  fig.width = 8,
  out.width = '100%',
  fig.asp = 0.63
  )

```

<br>
<br>

##  {.tabset .tabset-fade}


### Introducción  

<br>

### Paquetes empleados en el análisis.

<br>

```{r}
suppressMessages(library(DT)) 
suppressMessages(library(readr)) 
suppressMessages(library(readxl))
suppressMessages(library(lubridate))
suppressMessages(library(tidyverse))
suppressMessages(library(corrplot))
```

<br>

### Los datos

Se cuenta con un archivo .csv que contiene la cantidad de lluvia en milímetros por metro cuadrado para cada mes desde enero del año 1981 hasta diciembre de 2020. Para un total de 40 años y 480 meses. Esto para 83 cantones de Costa Rica.

<br>

Dichos cantones se muestran más adelante con ayuda de los nombres de las columnas del `tibble` que se va a crear.  

<br>

#### Leer los datos:

<br>

El siguiente código guarda los paths de todos los archivos que se encuentran dentro del folder indicado (`folder_path`).      
Posterior, se generó una función que convierte cada path en un tibble. 

<br>


```{r}
# Path del folder donde se encuentran los archivos a descargar en R. (datos)
folder_path <- "Datos_crudos"

# Encontrar todos los archivos dentro de la carpeta:
lista_archivos <- list.files(path = folder_path, recursive = TRUE, full.names = TRUE)

# Función para convertir los paths a tablas tipo tibble
combertir_a_tibble <- function(path) {
   if (endsWith(path, ".csv")) {
     tabla_a <- read_csv(path, show_col_types = FALSE)
   } else if (endsWith(path, ".xlsx")) {
     tabla_a <- read_excel(path)
   } else if (endsWith(path, ".tsv")) {
     tabla_a <- read_tsv(path, show_col_types = FALSE)
   } else if (endsWith(path, ".jpg")) {
     "borrar esta entrada"
   } else {
     nombre_archivo <- sub(".*/([^/]+)\\.[^/.]+$", "\\1", path)
     warning1 <- paste0("WARNING: hay un archivo en formato erroneo.
                        Con el nombre ", nombre_archivo)
     warning(warning1)
   }
}

```

<br>

El siguiente código llama la función creada `combertir_a_tibble` para cada path dentro de la lista 'lista_archivos' con la ayuda de la función `map`. 
<br>

```{r}
# El siguiente código llama la función 'combertir_a_tibble' 
# para cada path dentro de la lista 'lista_archivos'
 
tibble_list <- map(lista_archivos, ~ {
                   combertir_a_tibble(.) })

```

```{r}
length(tibble_list)
class(tibble_list)
```

<br> 

```{r}
datos_chirps_cr <- tibble_list[[1]]
```

<br>

Convierte los datos en datos numéricos:
```{r}
datos_chirps_cr <- datos_chirps_cr %>%
                  mutate(across(where(is.character), as.numeric))
```

<br>

### Análisis Exploratorio y Descriptivo
    
<br>

**Se obtienen las precipitaciones anuales:**
```{r}
datos_chirps_cr |> group_by(Year) |> 
  summarise(across(everything(), sum)) -> datos_by_year
```

```{r}
datos_chirps_cr |> group_by(Month) |> 
  summarise(across(everything(), mean)) -> mean_by_month
```


#### Nombre de los cantones:

```{r}
cantones <- datos_chirps_cr |> select(c(-1, -2)) |> names()
cantones
```

#### Promedios y desviaciones estandar, mensuales:

Para cada cantón:

```{r}
means <- apply(datos_chirps_cr[, 3:83], MARGIN = 2, mean)
desve <- apply(datos_chirps_cr[, 3:83], MARGIN = 2, sd)
promedios <- data.frame(cantones, promedios = means, Desv_Est = desve)
rownames(promedios) <- NULL
```

Cantones con los máximos promedios mensuales de precipitaciones: 
```{r}
head(arrange(promedios, desc(promedios)))
```
Cantones con los mínimos promedios mensuales de precipitaciones: 
```{r}
tail(arrange(promedios, desc(promedios)))
```

<br>

#### Por año y por mes:

Se obtiene el promedio de precipitación en los cantones por año. Y se obtiene los años con más y menos lluvias:
```{r}
means_yr <- apply(datos_by_year[, 3:83], MARGIN = 1, mean)
mean_by_year <- data.frame(año = datos_by_year$Year, 
                           promedio = means_yr)
mean_by_year
```

Años con los mayores promedios anuales de precipitaciones:
```{r}
head(arrange(mean_by_year, desc(promedio)), 3)
```

Años con los menores promedios anuales de precipitaciones:
```{r}
head(arrange(mean_by_year, promedio), 3)
```

<br>

Se obtiene el promedio mensual y se obtiene los años con más y menos lluvias:
```{r}
means_mes <- apply(mean_by_month[, 3:83], MARGIN = 1, mean)
promedios_mensuales <- data.frame(mes = mean_by_month$Month,
                                           promedio = means_mes)
promedios_mensuales
```

Meses con los mayores promedios anuales de precipitaciones:
```{r}
head(arrange(promedios_mensuales, desc(means_mes)), 3)
```

<br>

Meses con los menores promedios anuales de precipitaciones:
```{r}
tail(arrange(promedios_mensuales, desc(means_mes)), 3)

```


<br>

#### Histograma de algunos cantones:

Para los 3 cantones con más lluvias:
```{r}
ggplot(data = datos_chirps_cr, aes(x = JIMENEZ)) +
  geom_histogram(binwidth = 5, color = "black", fill = "skyblue") +
  labs(title = "Histograma para el cantón de Jiménez", 
       x = "Precipitación (mm)", y = "Frecuencia")

ggplot(data = datos_chirps_cr, aes(x = OSA)) +
  geom_histogram(binwidth = 5, color = "black", fill = "skyblue") +
  labs(title = "Histograma para el cantón de Osa", 
       x = "Precipitación (mm)", y = "Frecuencia")

ggplot(data = datos_chirps_cr, aes(x = GOLFITO)) +
  geom_histogram(binwidth = 5, color = "black", fill = "skyblue") +
  labs(title = "Histograma para el cantón de Golfito", 
       x = "Precipitación (mm)", y = "Frecuencia")
```

<br>

Para los 3 cantones con menos lluvias:
```{r}
ggplot(data = datos_chirps_cr, aes(x = `SAN JOSE`)) +
  geom_histogram(binwidth = 5, color = "black", fill = "skyblue") +
  labs(title = "Histograma para el cantón de San José", 
       x = "Precipitación (mm)", y = "Frecuencia")

ggplot(data = datos_chirps_cr, aes(x = `LA CRUZ`)) +
  geom_histogram(binwidth = 5, color = "black", fill = "skyblue") +
  labs(title = "Histograma para el cantón de La Cruz", 
       x = "Precipitación (mm)", y = "Frecuencia")

ggplot(data = datos_chirps_cr, aes(x = TIBAS)) +
  geom_histogram(binwidth = 5, color = "black", fill = "skyblue") +
  labs(title = "Histograma para el cantón de Tibas", 
       x = "Precipitación (mm)", y = "Frecuencia")
```

<br>

#### Gráfico de los promedios de precipitaciones mensuales:

```{r}
Sys.setlocale("LC_TIME", "Spanish")
promedios_mensuales$mes_nombre <-
  lubridate::month(promedios_mensuales$mes,label = T)
```


```{r}
ggplot(data = promedios_mensuales, aes(x = mes_nombre, y = promedio)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  geom_text(aes(label = round(promedio, 1)), vjust = -0.5, 
            color = "black", size = 3.5) +
  labs(title = "Promedio de Precipitación según el mes para los cantones de Costa Rica",
       x = "Mes",
       y = "Precipitacion (mm)")
```


<br>


#### Correlaciones entre las variables: 

```{r}
datos_numericos <- datos_chirps_cr |> dplyr::select(c(-1, -2))

corr_1 = cor(datos_numericos)

which(corr_1 < -0.5 & corr_1 > -0.99, arr.ind = TRUE)

gran_cor <- which(corr_1 > 0.9 & corr_1 <  1, arr.ind = TRUE)
gran_cor <- unique(gran_cor[ , 1])
corr_2 <- cor(datos_numericos[ , gran_cor])

datatable(corr_2)

```





