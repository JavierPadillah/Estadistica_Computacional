---
title: " "
subtitle:
author:
date: 
output: 
  html_document:
    theme: flatly
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  fig.align = 'center',
  fig.retina = 2,
  fig.width = 8,
  out.width = '90%',
  fig.asp = 0.63
  )

```

<br>

<center>

## **Universidad de Costa Rica**

#### Curso de Estadística Computacional (SP1669)

<br>

## **PCA para la precipitación de los cantones** 

## **de Costa Rica**

<br>

**Integrantes:**

Luis Jesús Molina

Natalie Mora

Javier Padilla H.

David Pérez C.

<br> <br>

20 de julio de 2023

</center>

<br>

---

<br>

##  {.tabset .tabset-fade}


### Introducción  

<br>

Los hallazgos obtenidos a través de este análisis tienen el potencial de ser de gran relevancia para diversas áreas, desde la agricultura y la gestión del agua, hasta la prevención de desastres naturales. Además, podrían proporcionar una base sólida para futuras investigaciones en el campo de la climatología, nutriendo así el conocimiento científico y contribuyendo a la toma de decisiones informadas en temas ambientales y sociales.

<br>

### Paquetes empleados en el análisis.

<br>

```{r}
suppressMessages(library(DT)) 
suppressMessages(library(readr)) 
suppressMessages(library(readxl))
suppressMessages(library(lubridate))
suppressMessages(library(tidyverse))
suppressMessages(library(corrplot))
suppressMessages(library(kableExtra))
suppressMessages(library(gt))

```

<br>

### Los datos

<br>

Se cuenta con un archivo .csv que contiene la cantidad de lluvia en milímetros por metro cuadrado para cada mes desde enero del año 1981 hasta diciembre de 2020. Para un total de 40 años y 480 meses. Esto para 81 cantones de Costa Rica.

<br>

#### Leer los datos:

<br>

El siguiente código guarda los paths de todos los archivos que se encuentran dentro del folder indicado (`folder_path`).      
Posterior, se generó una función que convierte cada path en un tibble. 

<br>


```{r}
# Path del folder donde se encuentran los archivos a descargar en R. (datos)
folder_path <- "Datos chirps"

# Encontrar todos los archivos dentro de la carpeta:
lista_archivos <- list.files(path = folder_path, recursive = TRUE, full.names = TRUE)

# Función para convertir los paths a tablas tipo tibble
combertir_a_tibble <- function(path) {
   if (endsWith(path, ".csv")) {
     tabla_a <- read_csv(path, show_col_types = FALSE)
   } else if (endsWith(path, ".xlsx")) {
     tabla_a <- read_excel(path)
   } else if (endsWith(path, ".tsv")) {
     tabla_a <- read_tsv(path, show_col_types = FALSE)
   } else if (endsWith(path, ".jpg")) {
     "borrar esta entrada"
   } else {
     nombre_archivo <- sub(".*/([^/]+)\\.[^/.]+$", "\\1", path)
     warning1 <- paste0("WARNING: hay un archivo en formato erroneo.
                        Con el nombre ", nombre_archivo)
     warning(warning1)
   }
}

```

<br>

El siguiente código llama la función creada `combertir_a_tibble` para cada path dentro de la lista 'lista_archivos' con la ayuda de la función `map`. 
<br>

```{r}
# El siguiente código llama la función 'combertir_a_tibble' 
# para cada path dentro de la lista 'lista_archivos'
 
tibble_list <- map(lista_archivos, ~ {
                   combertir_a_tibble(.) })

```

```{r}
length(tibble_list)
class(tibble_list)
```

<br> 

Se genera el tibble ("datos_chirps_cr") que se continuará utilizando durante el proyecto:
```{r}
datos_chirps_cr <- tibble_list[[1]]
```

<br>

Convierte los datos en datos numéricos (cuando corresponda):
```{r}
datos_chirps_cr <- datos_chirps_cr %>%
                  mutate(across(where(is.character), as.numeric))
```

<br>

### Análisis Exploratorio y Descriptivo
    
<br>

A continuación se realiza un análisis exploratorio y descriptivo de los datos, para la mejor comprensión y revelación de patrones en la información que alojan el conjunto de datos. En el presente artículo, nos enfocamos en estudiar minuciosamente los datos de precipitación recopilados durante el período de 40 años, desde enero de 1981 hasta diciembre de 2020, en los 81 cantones de Costa Rica. Estos datos, obtenidos a través de la fuente "chirps," representan una valiosa fuente de información climática que nos permite adentrarnos en los patrones de lluvia a lo largo del tiempo.  

El objetivo de esta sección es examinar a fondo estos datos, presentando tablas y gráficos que ilustran los promedios mensuales y anuales, desviaciones estándar, así como los valores máximos y mínimos de precipitación. Este análisis nos permitirá revelar tendencias notables, patrones estacionales y posibles cambios en el régimen de lluvias a lo largo de las últimas cuatro décadas.  

De esta manera, se puede entender con mayor profundidas el clima en Costa Rica, poniendo especial énfasis en las diferencias regionales que puedan existir entre los distintos cantones.


```{r include=FALSE}
## Se obtienen las precipitaciones promedio anual:
datos_chirps_cr |> group_by(Year) |> 
  summarise(across(everything(), mean)) -> datos_by_year
```

```{r include=FALSE}
## Se obtienen las Precipitaciones promedio mensuales:
datos_chirps_cr |> group_by(Month) |> 
  summarise(across(everything(), mean)) -> mean_by_month
```



```{r include=FALSE}
#### Nombre de los cantones:
cantones <- datos_chirps_cr |> select(c(-1, -2)) |> names()
cantones
```

<br>

A continuación, se obtuvieron los promedios y desviaciones estándar para los datos por cantón. Debido a un tema de espacio y tamaño de los cuadros, solo se presentan los cantones con valores promedios de precipitación mínimos y máximos. En el Cuadro X1 se presentan los 10 cantones que obtuvieron los máximos valores promedios mensuales de precipitación (mm) ordenados de mayor a menor y junto con sus respectivas desviaciones estándar. Mientras que, en el Cuadro X2 se presentan los 10 cantones con los valores mínimos de precipitación promedio, ordenados de igual forma. Esto para los los 480 meses analizados.

<br>

```{r include=FALSE}
means <- apply(datos_chirps_cr[, 3:83], MARGIN = 2, mean)
desve <- apply(datos_chirps_cr[, 3:83], MARGIN = 2, sd)
promedios <- data.frame(Cantones = cantones, 
                      Promedios = round(means, 2), Desv_Est = round(desve))
rownames(promedios) <- NULL

# datatable(promedios, rownames = FALSE, options = list(
#   autoWidth = TRUE,
#   columnDefs = list(list(width = '200px', targets = c(1, 3)))
# ))
```

```{r echo=FALSE }
### Cantones con los máximos promedios mensuales de precipitaciones:

# table_html1 <- knitr::kable(head(arrange(promedios, desc(Promedios))), 
# format="html",  row.names = FALSE )
# 
# kable_styling(table_html1, "striped", position = "left", full_width = F,
#               font_size = 12)

top_mensual <- promedios |> arrange(desc(Promedios)) |> top_n(10) |> gt() |>
    tab_header(
    title = md('**Cuadro X1.**<br> Cantones con los máximos promedios mensuales de precipitaciones') ) |> 
    tab_source_note( source_note = 'Fuente: Elaboración propia' ) |>
  cols_label(Desv_Est = 'Desv. Est.') |>
   tab_options(table.align = "left", heading.align = "left",
               table.font.size = 11)

top_mensual
```

<br>


```{r echo=FALSE}

# table_html2 <- knitr::kable(tail(arrange(promedios, desc(Promedios))),
#                            format="html", row.names = FALSE
#              )
# 
# kable_styling(table_html2, "striped", position = "left", full_width = F,
#               font_size = 12)

menor_mensual <- promedios |> arrange(desc(Promedios)) |> tail(10) |> gt()
menor_mensual |> tab_header(
    title = md('**Cuadro X2.**<br> Cantones con los mínimos promedios mensuales de precipitaciones') ) |> 
    tab_source_note( source_note = 'Fuente: Elaboración propia') |>
  cols_label(Desv_Est = 'Desv. Est.') |> 
  tab_options(table.align = "left", heading.align = "left",
               table.font.size = 11)

```

<br>

De forma similar se obtiene los valores de precipitación promedio para cada año evaluado. En el siguiente Cuadro **X3**, se muestran de mayor a menor los 10 años con las mayor cantidad promedio mensual de precipitación (mm).

```{r include=FALSE}
# Se obtiene el promedio de precipitación en los cantones por año. Y se obtiene los años con más y menos lluvias:

means_yr <- apply(datos_by_year[, 3:83], MARGIN = 1, mean)
sd_yr <- apply(datos_by_year[, 3:83], MARGIN = 1, sd)

mean_by_year <- data.frame(Año = datos_by_year$Year, 
                           Promedio = round(means_yr, 2),
                           Est_Dev = round(sd_yr, 2) )
mean_by_year
```


<br>

```{r echo=FALSE}
# datatable(arrange(mean_by_year, desc(Promedio)), 
#           options = list(style = 'font-size: 6px;',
#                          width = '100px'), rownames = FALSE)

top_anual <- mean_by_year |> arrange(desc(Promedio)) |> top_n(10) |> gt()
top_anual |> tab_header(
    title = md('**Cuadro X3.**<br> Máximos valores promedio de precipitación mensual para los cantones de Costa Rica de acuerdo con el año') ) |> 
    tab_source_note( source_note = 'Fuente: Elaboración propia'
    ) |>
  cols_label(Est_Dev = 'Desv. Est.') |> 
  tab_options(table.align = "left", heading.align = "left",
               table.font.size = 11)

```

<br>

Sumado a lo anterior, en el Cuadro **X4**, se muestran de mayor a menor los 10 años con los menores promedios mensuales de precipitación (mm).

<br>

```{r echo=FALSE}
# datatable(arrange(mean_by_year, desc(Promedio)), 
#           options = list(style = 'font-size: 6px;',
#                          width = '100px'), rownames = FALSE)

top_anual <- mean_by_year |> arrange(desc(Promedio)) |> tail(10) |> gt()
top_anual |> tab_header(
    title = md('**Cuadro X4.**<br> Mínimos valores promedio de precipitación mensual para los cantones de Costa Rica de acuerdo con el año') ) |> 
    tab_source_note( source_note = 'Fuente: Elaboración propia'
    ) |>
  cols_label(Est_Dev = 'Desv. Est.') |> 
  tab_options(table.align = "left", heading.align = "left",
               table.font.size = 11)

```

<br>

En el siguiente Gráfico 1, se muestran, en un gráfico de barras, los años en evaluación con su respectiva precipitación mensual promedio (mm).

<br>

**Gráfico 1.** <br> Promedio de la precipitación mensual para los cantones de Costa Rica de acuerdo con el año
```{r echo=FALSE, fig.align='left', out.width='900px', out.height='400px'}
ggplot(data = mean_by_year, aes(x = Año, y = Promedio)) +
  geom_bar(stat = "identity", fill = "darkblue") +
  geom_text(aes(label = round(Promedio, 0)), vjust = -0.5, 
            color = "grey6", size = 2) +
  labs(title = "",
       x = "Año",
       y = "Precipitacion (mm)") +
  scale_x_continuous(breaks = mean_by_year$Año, 
                     labels = mean_by_year$Año) +
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5, hjust = 1))
```

<br>

```{r include=FALSE}

## Se obtiene el promedio para cada mes.
means_mes <- apply(mean_by_month[, 3:83], MARGIN = 1, mean)
promedios_mensuales <- data.frame(Mes = mean_by_month$Month,
                                        Promedio = round(means_mes, 1))
promedios_mensuales

```



```{r include=FALSE}
## Meses con los mayores promedios anuales de precipitaciones:
head(arrange(promedios_mensuales, desc(means_mes)), 3)
```

```{r include=FALSE}
## Meses con los menores promedios anuales de precipitaciones:
tail(arrange(promedios_mensuales, desc(means_mes)), 3)

```

<br>

En el siguiente Gráfico 2. se presentan los promedios de precipitación mensuales de los 81 cantones de Costa Rica. En este se puede apreciar que los meses más lluviosos son octubre, septiembre y mayo, con precipitaciones promedio de 416.5 mm, 364.2 mm, y 319.4 mm respectivamente.   
Mientras que los meses menos lluviosos son enero, marzo y febrero, con precipitaciones promedio de 76.3 mm, 48.2 mm, y 42.9 mm respectivamente.  

<br>

```{r include=FALSE}
Sys.setlocale("LC_TIME", "Spanish")
promedios_mensuales$mes_nombre <- lubridate::month(promedios_mensuales$Mes, 
                                                   label = T)
```

**Gráfico 2.** <br> Promedio de precipitación según el mes para los cantones de Costa Rica
```{r echo=FALSE, fig.align='left', out.width='850px', out.height='450px'}
ggplot(data = promedios_mensuales, aes(x = mes_nombre, y = Promedio)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  geom_text(aes(label = round(Promedio, 0)), vjust = -0.5, 
            color = "black", size = 2.2) +
  labs(title = "",
       x = "Mes",
       y = "Precipitacion (mm)")
```


<br>

```{r include=FALSE}
#### Correlaciones entre las variables: 
datos_numericos <- datos_chirps_cr |> dplyr::select(c(-1, -2))

corr_1 = cor(datos_numericos)

which(corr_1 < -0.5 & corr_1 > -0.99, arr.ind = TRUE) ## No hay correlaciones negativas

min(corr_1)
which(corr_1 < 0.05 & corr_1 > 0, arr.ind = TRUE) ## Bajas corr

corr_1[c(15, 38, 41, 69, 72), c(15, 38, 41, 69, 72)]

which(corr_1 > 0.995 & corr_1 <  1, arr.ind = TRUE)

corr_1[c(2, 8, 11, 12, 16, 19, 22, 23, 25, 26, 27, 42, 44, 47, 50, 52, 62, 63, 64, 67, 68, 70, 75, 78), c(2, 8, 11, 12, 16, 19, 22, 23, 25, 26, 27, 42, 44, 47, 50, 52, 62, 63, 64, 67, 68, 70, 75, 78)]
```

En cuanto a las correlaciones entre las variables a analizar las cuales en este estudio son los 81 cantones de Costa Rica, es decir, se cuenta con 81 variables para las cuales se puede evaluar si se encuentran correlacionadas o no.

Se encontró que, en generar las correlaciones entre la cantidad de precipitación de los cantones es muy alta. En el siguiente Cuadro X5. se muestra algunas de las altas correlaciones entre cantones.

```{r echo=FALSE}
cuadro_corr <- datos_chirps_cr |> dplyr::select('TIBAS', 'CURRIDABAT', 'SAN JOSE', 'GOICOECHEA', 'ASERRI', 'ACOSTA',  'FLORES', 'BELEN', 'OROTINA', 'SAN MATEO')

corr_cuadro <- round(cor(cuadro_corr), 3)
corr_cuadro <- as.data.frame(corr_cuadro)
corr_cuadro$Cantones <- rownames(corr_cuadro)
corr_cuadro <- corr_cuadro |> relocate(Cantones)
corr_cuadro |> gt() |> 
  tab_options(table.align = "left", heading.align = "left",
               table.font.size = 10) |>
  tab_header(title = md('**Cuadro X5.**<br> Correlaciones entre las precipitaciones mensuales de 10 cantones de Costa Rica para los años entre 1981 y 2020') ) |> 
    tab_source_note( source_note = 'Fuente: Elaboración propia'
    ) 
```

<br>

Mientras que, parejas de cantones como Matina y Carrillo; o Siquirres y Carrillo, presentan una baja correlaciones en cuanto a la cantidad de precipitación mensual, con correlaciones iguales a 0.012 y 0.022 respectivamente.


<br>











